---
description: 通过最多 5 个高度聚焦的问题发现并澄清当前功能规范中的欠规范区域，并把答案写回规范。
---

向你提供的用户输入可以由智能体直接传入，或作为命令参数提供——如果不为空，你在继续执行提示前**必须**予以考虑。

User input:

$ARGUMENTS

目标：识别并减少活动中的功能规范中的歧义或缺失决策点，并将澄清结果直接记录回规范文件。

注意：本澄清流程应在调用 `/plan` 之前运行并完成。若用户明确表示跳过澄清（例如探索性 Spike），可以继续，但必须警告下游返工风险会增加。

执行步骤：

1. 从仓库根目录**仅运行一次** `.specify/scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly`（即 `--json --paths-only` 组合 / `-Json -PathsOnly`）。解析最小 JSON 负载字段：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可选捕获 `IMPL_PLAN`、`TASKS` 以便后续联动流程）
   - 若 JSON 解析失败，中止并提示用户重新运行 `/specify` 或检查功能分支环境。

2. 读取当前规范文件。按照以下分类执行结构化的歧义与覆盖扫描。对每类标注状态：Clear / Partial / Missing。生成用于优先级排序的内部覆盖映射（除非无需发问，否则不要输出原始映射）。

   Functional Scope & Behavior：
   - 核心用户目标与成功标准
   - 明确的非目标/不在范围声明
   - 用户角色 / 画像区分

   Domain & Data Model：
   - 实体、属性、关系
   - 身份与唯一性规则
   - 生命周期/状态变迁
   - 数据量/规模假设

   Interaction & UX Flow：
   - 关键用户旅程/序列
   - 错误/空/加载状态
   - 无障碍或本地化说明

   Non-Functional Quality Attributes：
   - 性能（延迟、吞吐目标）
   - 可扩展性（横向/纵向，上限）
   - 可靠性与可用性（正常运行时间、恢复预期）
   - 可观测性（日志、指标、追踪信号）
   - 安全与隐私（认证/授权、数据保护、威胁假设）
   - 合规/监管约束（如有）

   Integration & External Dependencies：
   - 外部服务/API 及其失效模式
   - 数据导入/导出格式
   - 协议/版本假设

   Edge Cases & Failure Handling：
   - 负向场景
   - 限流/节流
   - 冲突解决（例如并发编辑）

   Constraints & Tradeoffs：
   - 技术约束（语言、存储、托管）
   - 明确的权衡或被否决的替代方案

   Terminology & Consistency：
   - 规范术语表
   - 避免同义词/弃用术语

   Completion Signals：
   - 验收标准的可测试性
   - 可度量的完成定义（DoD）指示器

   Misc / Placeholders：
   - TODO 标记/未决事项
   - 模糊形容词（如 “robust”、“intuitive”）缺少量化

   对状态为 Partial 或 Missing 的类别（除非满足以下任一条件）生成候选问题：
   - 澄清不会显著影响实施或验证策略
   - 更适合在规划阶段处理（内部记录）

3.（内部）生成按优先级排序的候选澄清问题队列（最多 5 个）。不要一次性全部输出。遵循：
    - 整个会话最多 5 个问题。
    - 每个问题必须能用以下其一作答：
       * 简短多选（2–5 个互斥选项），或
       * 单词/短语回答（明确约束：“不超过 5 个词”）。
   - 仅包含会实质性影响架构、数据建模、任务拆解、测试设计、交互行为、运维准备或合规验证的问题。
   - 确保类别覆盖平衡：优先覆盖最高影响的未决类别；避免在存在高影响未决项时提出两个低影响问题。
   - 排除已回答的问题、琐碎偏好、或仅与计划阶段执行细节相关（除非阻碍正确性）。
   - 倾向于能减少下游返工或避免验收测试偏差的问题。
   - 若未决类别超过 5 个，按（Impact × Uncertainty）启发式选前 5 个。

4. 逐步提问循环（交互式）：
    - 每次只呈现且仅呈现 1 个问题。
    - 对多选题，使用 Markdown 表格渲染选项：

       | Option | Description |
       |--------|-------------|
       | A | <Option A description> |
       | B | <Option B description> |
       | C | <Option C description> |（按需增加 D/E，最多 5 个）
       | Short | 提供不同的简短答案（<=5 个词） |（仅在适合自由回答时包含）

    - 对短答题（无有意义离散选项），在问题后单独输出一行：`Format: Short answer (<=5 words)`。
    - 用户回答后：
       * 校验回答是否映射某一选项或满足 ≤5 词约束。
       * 如有歧义，请快速二次澄清（仍计为同一问题；不前进队列）。
       * 一旦满意，记录进工作内存（先不落盘），然后进入下一个问题。
    - 在以下任一条件满足时停止继续发问：
       * 关键歧义已提前全部解决（剩余队列变得不必要），或
       * 用户发出完成信号（“done”、“good”、“no more”），或
       * 已达到 5 个问题上限。
    - 切勿提前暴露未来排队问题。
    - 若开始时不存在有效问题，立即报告“无关键歧义”。

5. 每次接受答案后的集成（增量更新）：
    - 维护内存中的规范表示（会话启动时加载一次）以及原始文件内容。
    - 会话中的第一个集成答案：
       * 确保存在 `## Clarifications` 章节（若缺失，按模板在最高级上下文/概览章节之后创建）。
       * 在其下创建（若缺失）`### Session YYYY-MM-DD` 子标题（今天）。
    - 在接受后立即追加一条项目符号：`- Q: <question> → A: <final answer>`。
    - 随后将澄清应用到最合适的章节：
       * 功能歧义 → 在 Functional Requirements 更新/新增条目。
       * 交互/参与者区分 → 在 User Stories 或 Actors（如存在）更新角色、约束或情景。
       * 数据形态/实体 → 在 Data Model 更新字段、类型、关系，并简洁标注新增约束。
       * 非功能约束 → 在 Non-Functional / Quality Attributes 增改可度量标准。
       * 边界/负向流程 → 在 Edge Cases / Error Handling 下新增条目（或按模板创建）。
       * 术语冲突 → 全文统一标准术语；如需保留旧称，仅一次性注明 `(formerly referred to as "X")`。
    - 若澄清使先前的含糊表述失效，应替换而非重复；不得遗留过时的矛盾文本。
    - 每次集成后立即保存规范（原子覆盖）。
    - 保持格式：不重排无关章节；保持标题层级不变。
    - 保持每条插入内容最小化且可测试，避免叙事性扩张。

6. 校验（每次写入后和最终）：
   - 澄清会话中每个被接受的答案恰有一条项目符号（无重复）。
   - 已提问（被接受）的问题总数 ≤ 5。
   - 更新后的章节不再残留原本该解决的模糊占位。
   - 不存在仍存的自相矛盾旧陈述。
   - Markdown 结构有效；仅允许新增 `## Clarifications`、`### Session YYYY-MM-DD`。
   - 术语一致：各更新章节使用同一标准术语。

7. 将更新后的规范写回 `FEATURE_SPEC`。

8. 报告完成（提问循环结束或提前终止后）：
   - 已提问与解答的数量。
   - 更新后的规范文件路径。
   - 涉及的章节（列出名称）。
   - 覆盖汇总表：各分类的状态（Resolved/Deferred/Clear/Outstanding）。
   - 若仍有 Outstanding 或 Deferred，建议继续 `/plan` 或稍后再次运行 `/clarify`。
   - 建议的下一步命令。

行为规则：
- 若未发现有意义的歧义（或所有潜在问题影响低），回复：“未检测到值得正式澄清的关键歧义”，并建议继续推进。
- 若缺少规范文件，提示先运行 `/specify`（这里不创建新规范）。
- 切勿超过 5 个问题（同一问题的二次澄清不计入）。
- 避免对技术栈提出纯推测性问题，除非其缺失阻碍功能清晰。
- 尊重用户的提前终止信号（“stop”、“done”、“proceed”）。
- 若因覆盖已足而未提问，输出精简覆盖总结（全部 Clear），并建议推进。
- 若已达配额且仍有高影响未决项，明确将其记为 Deferred 并说明理由。

Context for prioritization: $ARGUMENTS
